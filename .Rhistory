Step == "SNPs"      ~ factor(Value, levels = lev_SNPs),
Step == "DMGs"      ~ factor(Value, levels = lev_DMGs),
Step == "DEGs"      ~ factor(Value, levels = lev_DEGs),
Step == "Pathways"  ~ factor(Value, levels = lev_Path),
TRUE                ~ Value
),
Step = factor(Step, levels = c("SNPs", "DMGs", "DEGs", "Pathways"))
)
# 计算 Pathways 标签位置（按新顺序）
pathway_y <- df_long %>%
filter(Step == "Pathways") %>%
count(Value) %>%
arrange(match(Value, lev_Path)) %>%   # 确保顺序是 A,B,C,D
mutate(y_pos = cumsum(n) - n / 2)
# 绘图
p <- ggplot(df_long,
aes(x = Step, stratum = Value, alluvium = id,
y = after_stat(count), fill = Step)) +
geom_alluvium(width = 0.3, alpha = 0.7, knot.pos = 0.2) +
geom_stratum(width = 0.3, alpha = 0.8) +
scale_fill_manual(values = c("#FF6B6B", "#4ECDC4", "#45B7D1", "#96CEB4")) +
theme_minimal(base_size = 12) +
labs(title = "Gene Flow Sorted by Pathway (A → B → C → D)",
x = NULL, y = "Number of Links") +
theme(
axis.text.x = element_text(size = 11, face = "bold"),
axis.text.y = element_blank(),
axis.ticks.y = element_blank(),
panel.grid = element_blank()
)
# 添加 Pathway 标签（右侧）
p + annotate(
"text",
x = 4,
y = pathway_y$y_pos,
label = as.character(pathway_y$Value),
size = 4.5,
fontface = "bold",
hjust = -0.2,
color = "black"
)
library(ggalluvial)
library(tidyverse)
# 原始数据
df <- read.table(text = "
SNPs DMGs DEGs Pathways
gene1 gene3 gene5 A
gene2 gene4 gene6 A
gene3 gene5 gene7 B
gene4 gene6 gene8 B
gene5 gene7 gene9 B
gene6 gene8 gene10 D
gene7 gene9 gene11 D
NA gene10 gene12 C
NA gene11 gene13 C
NA NA gene14 C
", header = TRUE, stringsAsFactors = FALSE)
# ====== 按 Pathway 排序（A, B, C, D） ======
desired_path_order <- c("A", "B", "C", "D")
df <- df %>%
mutate(Pathways = factor(Pathways, levels = desired_path_order)) %>%
arrange(Pathways) %>%
mutate(id = row_number())
# ====== 获取各列基因的显示顺序 ======
lev_SNPs <- unique(na.omit(df$SNPs))
lev_DMGs <- unique(na.omit(df$DMGs))
lev_DEGs <- unique(na.omit(df$DEGs))
lev_Path <- desired_path_order
# 转长格式
df_long <- df %>%
pivot_longer(cols = c(SNPs, DMGs, DEGs, Pathways),
names_to = "Step",
values_to = "Value") %>%
filter(!is.na(Value)) %>%
mutate(
Value = case_when(
Step == "SNPs"      ~ factor(Value, levels = lev_SNPs),
Step == "DMGs"      ~ factor(Value, levels = lev_DMGs),
Step == "DEGs"      ~ factor(Value, levels = lev_DEGs),
Step == "Pathways"  ~ factor(Value, levels = lev_Path),
TRUE                ~ Value
),
Step = factor(Step, levels = c("SNPs", "DMGs", "DEGs", "Pathways"))
)
# ====== 为每一列计算标签 y 位置 ======
get_label_positions <- function(step_name, value_levels) {
df_long %>%
filter(Step == step_name) %>%
count(Value) %>%
# 按指定因子顺序排列
arrange(match(Value, value_levels)) %>%
mutate(y_pos = cumsum(n) - n / 2)
}
label_SNPs <- get_label_positions("SNPs", lev_SNPs)
label_DMGs <- get_label_positions("DMGs", lev_DMGs)
label_DEGs <- get_label_positions("DEGs", lev_DEGs)
label_Path <- get_label_positions("Pathways", lev_Path)
# 绘图
p <- ggplot(df_long,
aes(x = Step, stratum = Value, alluvium = id,
y = after_stat(count), fill = Step)) +
geom_alluvium(width = 0.3, alpha = 0.7, knot.pos = 0.2) +
geom_stratum(width = 0.3, alpha = 0.8) +
scale_fill_manual(values = c("#FF6B6B", "#4ECDC4", "#45B7D1", "#96CEB4")) +
theme_minimal(base_size = 12) +
labs(title = "Gene Flow with Full Labels (Sorted by Pathway)",
x = NULL, y = "Number of Links") +
theme(
axis.text.x = element_text(size = 11, face = "bold"),
axis.text.y = element_blank(),
axis.ticks.y = element_blank(),
panel.grid = element_blank()
)
# ====== 添加四列标签 ======
p_final <- p +
# SNPs (x=1)
annotate("text", x = 1, y = label_SNPs$y_pos,
label = as.character(label_SNPs$Value),
size = 3, hjust = -0.2, color = "black") +
# DMGs (x=2)
annotate("text", x = 2, y = label_DMGs$y_pos,
label = as.character(label_DMGs$Value),
size = 3, hjust = -0.2, color = "black") +
# DEGs (x=3)
annotate("text", x = 3, y = label_DEGs$y_pos,
label = as.character(label_DEGs$Value),
size = 3, hjust = -0.2, color = "black") +
# Pathways (x=4)
annotate("text", x = 4, y = label_Path$y_pos,
label = as.character(label_Path$Value),
size = 3.5, fontface = "bold", hjust = -0.2, color = "black")
print(p_final)
library(ggalluvial)
library(tidyverse)
df <- read.table(text = "
SNPs DMGs DEGs Pathways
gene1 gene3 gene5 A
gene2 gene4 gene6 A
gene3 gene5 gene7 B
gene4 gene6 gene8 B
gene5 gene7 gene9 B
gene6 gene8 gene10 D
gene7 gene9 gene11 D
NA gene10 gene12 C
NA gene11 gene13 C
NA NA gene14 C
", header = TRUE, stringsAsFactors = FALSE)
# 按通路排序
desired_path_order <- c("A", "B", "C", "D")
df <- df %>%
mutate(Pathways = factor(Pathways, levels = desired_path_order)) %>%
arrange(Pathways) %>%
mutate(id = row_number())  # 这个 id 将决定流的垂直顺序
# 转长格式
df_long <- df %>%
pivot_longer(cols = c(SNPs, DMGs, DEGs, Pathways),
names_to = "Step",
values_to = "Value") %>%
filter(!is.na(Value)) %>%
mutate(
Step = factor(Step, levels = c("SNPs", "DMGs", "DEGs", "Pathways")),
# 各列按排序后首次出现顺序设为因子
Value = case_when(
Step == "SNPs"      ~ factor(Value, levels = unique(na.omit(df$SNPs))),
Step == "DMGs"      ~ factor(Value, levels = unique(na.omit(df$DMGs))),
Step == "DEGs"      ~ factor(Value, levels = unique(na.omit(df$DEGs))),
Step == "Pathways"  ~ factor(Value, levels = desired_path_order),
TRUE                ~ Value
)
)
# === 关键：使用 y = 1 + order = id ===
p <- ggplot(df_long,
aes(x = Step, stratum = Value, alluvium = id,
y = 1,                     # ⭐ 每行高度=1
fill = Step)) +
geom_alluvium(aes(order = id),          # ⭐ 强制按 id 顺序
width = 0.25, alpha = 0.7) +
geom_stratum(width = 0.25, alpha = 0.8) +
scale_fill_manual(values = c("#E74C3C", "#3498DB", "#2ECC71", "#F39C12")) +
theme_void()
# === 精准添加标签（基于实际绘图坐标）===
# 先获取 stratum 的真实位置
stratum_data <- layer_data(p, i = 2)
# 提取标签位置（ggalluvial v0.12.3+ 中，stratum 名在 'stratum' 列）
label_df <- stratum_data %>%
select(x, y, label = stratum) %>%
mutate(x = x + 0.15)
# 叠加标签
p_final <- p +
geom_text(data = label_df,
aes(x = x, y = y, label = label),
size = 2.8, hjust = 0, color = "black") +
labs(title = "Exact Flow: One Row = One Stream (Sorted by Pathway)") +
theme(plot.title = element_text(hjust = 0.5))
print(p_final)
# 加载必要包
library(ggalluvial)
library(tidyverse)
# 原始数据
df <- read.table(text = "
SNPs DMGs DEGs Pathways
gene1 gene3 gene5 A
gene2 gene4 gene6 A
gene3 gene5 gene7 B
gene4 gene6 gene8 B
gene5 gene7 gene9 B
gene6 gene8 gene10 D
gene7 gene9 gene11 D
NA gene10 gene12 C
NA gene11 gene13 C
NA NA gene14 C
", header = TRUE, stringsAsFactors = FALSE)
# 按目标通路顺序排序：A, B, C, D
desired_path_order <- c("A", "B", "C", "D")
df <- df %>%
mutate(Pathways = factor(Pathways, levels = desired_path_order)) %>%
arrange(Pathways) %>%
mutate(id = row_number())  # id 决定流的垂直顺序
# 转换为长格式
df_long <- df %>%
pivot_longer(
cols = c(SNPs, DMGs, DEGs, Pathways),
names_to = "Step",
values_to = "Value"
) %>%
filter(!is.na(Value)) %>%
mutate(
Step = factor(Step, levels = c("SNPs", "DMGs", "DEGs", "Pathways")),
Value = case_when(
Step == "SNPs"      ~ factor(Value, levels = unique(na.omit(df$SNPs))),
Step == "DMGs"      ~ factor(Value, levels = unique(na.omit(df$DMGs))),
Step == "DEGs"      ~ factor(Value, levels = unique(na.omit(df$DEGs))),
Step == "Pathways"  ~ factor(Value, levels = desired_path_order),
TRUE                ~ Value
)
)
# === 绘图：使用 y = 1 + order = id 确保顺序一致 ===
p_base <- ggplot(
df_long,
aes(
x = Step,
stratum = Value,
alluvium = id,
y = 1,               # 每行高度为1，不聚合
fill = Step
)
) +
geom_alluvium(aes(order = id), width = 0.25, alpha = 0.7) +
geom_stratum(width = 0.25, alpha = 0.8) +
scale_fill_manual(values = c("#E74C3C", "#3498DB", "#2ECC71", "#F39C12")) +
theme_void()
# === 提取 stratum 的真实绘图坐标 ===
stratum_data <- layer_data(p_base, i = 2)  # 第2层是 geom_stratum
# 查看列名（调试用，正式运行可注释）
# print(names(stratum_data))
# 在较新版本 ggalluvial 中，stratum 名称通常在 'stratum' 列
# 如果报错，请取消下一行注释查看实际结构：
# head(stratum_data)
# 构建标签数据框
label_df <- stratum_data %>%
select(x = x, y = y, label = stratum) %>%   # ⭐ 关键：使用 'stratum'
mutate(x = x + 0.15)                        # 向右偏移避免遮挡
# === 添加标签并输出最终图 ===
p_final <- p_base +
geom_text(
data = label_df,
aes(x = x, y = y, label = label),         # 映射来自 label_df
size = 2.8,
hjust = 0,
color = "black"
) +
labs(title = "Gene Flow: One Row = One Stream (Sorted by Pathway A→B→C→D)") +
theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"))
# 显示图形
print(p_final)
library(ggalluvial)
library(tidyverse)
# 原始数据
df <- read.table(text = "
SNPs DMGs DEGs Pathways
gene1 gene3 gene5 A
gene2 gene4 gene6 A
gene3 gene5 gene7 B
gene4 gene6 gene8 B
gene5 gene7 gene9 B
gene6 gene8 gene10 D
gene7 gene9 gene11 D
NA gene10 gene12 C
NA gene11 gene13 C
NA NA gene14 C
", header = TRUE, stringsAsFactors = FALSE)
# 按通路排序：A, B, C, D
desired_path_order <- c("A", "B", "C", "D")
df <- df %>%
mutate(Pathways = factor(Pathways, levels = desired_path_order)) %>%
arrange(Pathways) %>%
mutate(id = row_number())
# 转长格式
df_long <- df %>%
pivot_longer(cols = c(SNPs, DMGs, DEGs, Pathways),
names_to = "Step",
values_to = "Value") %>%
filter(!is.na(Value)) %>%
mutate(
Step = factor(Step, levels = c("SNPs", "DMGs", "DEGs", "Pathways")),
Value = case_when(
Step == "SNPs"      ~ factor(Value, levels = unique(na.omit(df$SNPs))),
Step == "DMGs"      ~ factor(Value, levels = unique(na.omit(df$DMGs))),
Step == "DEGs"      ~ factor(Value, levels = unique(na.omit(df$DEGs))),
Step == "Pathways"  ~ factor(Value, levels = desired_path_order),
TRUE                ~ Value
)
)
# 绘图基础（关键：y = 1 + order = id）
p_base <- ggplot(df_long,
aes(x = Step, stratum = Value, alluvium = id,
y = 1, fill = Step)) +
geom_alluvium(aes(order = id), width = 0.25, alpha = 0.7) +
geom_stratum(width = 0.25, alpha = 0.8) +
scale_fill_manual(values = c("#E74C3C", "#3498DB", "#2ECC71", "#F39C12")) +
theme_void()
# === 安全提取标签位置（兼容所有 ggalluvial 版本）===
stratum_data <- layer_data(p_base, i = 2)
# 自动检测节点名称所在列
label_col <- if ("stratum" %in% names(stratum_data)) {
"stratum"
} else if ("fill" %in% names(stratum_data)) {
"fill"
} else {
stop("无法找到节点标签列，请检查 layer_data 输出")
}
# 使用 ymin 和 ymax 计算中心 y（最可靠方式）
label_df <- stratum_data %>%
mutate(
x_pos = x,
y_pos = (ymin + ymax) / 2,
label_text = .data[[label_col]]
) %>%
select(x = x_pos, y = y_pos, label = label_text) %>%
mutate(x = x + 0.15)  # 向右偏移
# 添加标签
p_final <- p_base +
geom_text(
data = label_df,
mapping = aes(x = x, y = y, label = label),  # 显式使用 mapping 避免环境混淆
size = 2.8,
hjust = 0,
color = "black"
) +
labs(title = "Gene Flow: Sorted by Pathway (A → B → C → D)") +
theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"))
# 输出图形
print(p_final)
library(ggalluvial)
library(tidyverse)
# 原始数据
df <- read.table(text = "
SNPs DMGs DEGs Pathways
gene1 gene3 gene5 A
gene2 gene4 gene6 A
gene3 gene5 gene7 B
gene4 gene6 gene8 B
gene5 gene7 gene9 B
gene6 gene8 gene10 D
gene7 gene9 gene11 D
NA gene10 gene12 C
NA gene11 gene13 C
NA NA gene14 C
", header = TRUE, stringsAsFactors = FALSE)
# 按通路排序：A, B, C, D
desired_path_order <- c("A", "B", "C", "D")
df <- df %>%
mutate(Pathways = factor(Pathways, levels = desired_path_order)) %>%
arrange(Pathways) %>%
mutate(id = row_number())
# 转长格式
df_long <- df %>%
pivot_longer(cols = c(SNPs, DMGs, DEGs, Pathways),
names_to = "Step",
values_to = "Value") %>%
filter(!is.na(Value)) %>%
mutate(
Step = factor(Step, levels = c("SNPs", "DMGs", "DEGs", "Pathways")),
Value = case_when(
Step == "SNPs"      ~ factor(Value, levels = unique(na.omit(df$SNPs))),
Step == "DMGs"      ~ factor(Value, levels = unique(na.omit(df$DMGs))),
Step == "DEGs"      ~ factor(Value, levels = unique(na.omit(df$DEGs))),
Step == "Pathways"  ~ factor(Value, levels = desired_path_order),
TRUE                ~ Value
)
)
# 绘图基础（关键：y = 1 + order = id）
p_base <- ggplot(df_long,
aes(x = Step, stratum = Value, alluvium = id,
y = 1, fill = Step)) +
geom_alluvium(aes(order = id), width = 0.25, alpha = 0.7) +
geom_stratum(width = 0.25, alpha = 0.8) +
scale_fill_manual(values = c("#E74C3C", "#3498DB", "#2ECC71", "#F39C12")) +
theme_void()
# === 安全提取标签位置（终极解决方案）===
stratum_data <- layer_data(p_base, i = 2)
# 确保我们使用正确的列名
label_col <- if ("stratum" %in% names(stratum_data)) {
"stratum"
} else if ("fill" %in% names(stratum_data)) {
"fill"
} else {
stop("无法找到标签列，请检查 ggalluvial 版本")
}
# 创建标签数据框（直接使用 label_col 的值）
label_df <- data.frame(
x = stratum_data$x + 0.15,
y = (stratum_data$ymin + stratum_data$ymax) / 2,
label = as.character(stratum_data[[label_col]])
)
# === 关键修复：使用 label_df 的 label 列 ===
p_final <- p_base +
geom_text(
data = label_df,
aes(x = x, y = y, label = label),  # 这里使用 label 列（不是 Value！）
size = 2.8,
hjust = 0,
color = "black"
) +
labs(title = "Gene Flow: Sorted by Pathway (A → B → C → D)") +
theme(
plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
axis.text = element_blank(),
axis.ticks = element_blank()
)
# 输出图形
print(p_final)
library(ggalluvial)
library(tidyverse)
# 原始数据
df <- read.table(text = "
SNPs DMGs DEGs Pathways
gene1 gene3 gene5 A
gene2 gene4 gene6 A
gene3 gene5 gene7 B
gene4 gene6 gene8 B
gene5 gene7 gene9 B
gene6 gene8 gene10 D
gene7 gene9 gene11 D
NA gene10 gene12 C
NA gene11 gene13 C
NA NA gene14 C
", header = TRUE, stringsAsFactors = FALSE)
# 按通路排序：A, B, C, D
desired_path_order <- c("A", "B", "C", "D")
df <- df %>%
mutate(Pathways = factor(Pathways, levels = desired_path_order)) %>%
arrange(Pathways) %>%
mutate(id = row_number())
# 转长格式
df_long <- df %>%
pivot_longer(cols = c(SNPs, DMGs, DEGs, Pathways),
names_to = "Step",
values_to = "Value") %>%
filter(!is.na(Value)) %>%
mutate(
Step = factor(Step, levels = c("SNPs", "DMGs", "DEGs", "Pathways")),
Value = case_when(
Step == "SNPs"      ~ factor(Value, levels = unique(na.omit(df$SNPs))),
Step == "DMGs"      ~ factor(Value, levels = unique(na.omit(df$DMGs))),
Step == "DEGs"      ~ factor(Value, levels = unique(na.omit(df$DEGs))),
Step == "Pathways"  ~ factor(Value, levels = desired_path_order),
TRUE                ~ Value
)
)
# 绘图基础
p_base <- ggplot(df_long,
aes(x = Step, stratum = Value, alluvium = id,
y = 1, fill = Step)) +
geom_alluvium(aes(order = id), width = 0.25, alpha = 0.7) +
geom_stratum(width = 0.25, alpha = 0.8) +
scale_fill_manual(values = c("#E74C3C", "#3498DB", "#2ECC71", "#F39C12")) +
theme_void()
# 添加标签的正确方式（这才是关键！）
p_final <- p_base +
geom_text(
stat = "stratum",
aes(label = after_stat(stratum)),
size = 2.8,
hjust = 0,
color = "black"
) +
labs(title = "Gene Flow: Sorted by Pathway (A → B → C → D)") +
theme(
plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
axis.text = element_blank(),
axis.ticks = element_blank()
)
# 输出图形
print(p_final)
setwd("D:/4.Code/SeuratVisPro")
devtools::document()
devtools::document()
remove.packages("SeuratVisPro")
pkgdown::build_site()
pkgdown::build_site()
remove.packages("SeuratVisPro")
remove.packages("SeuratVisPro")
remove.packages("SeuratVisPro")
devtools::load_all(".")
remove.packages("SeuratVisPro")
launchSeuratVisPro()
remove.packages("SeuratVisPro")
launchSeuratVisPro()
pkgdown::build_site()
pkgdown::build_site()
pkgdown::build_site()
